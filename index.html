<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>F-Shutter Heart Camera</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <style>
    body {margin:0;overflow:hidden;background:#000;color:white;font-family:monospace;}
    #canvas, #graph, #canvasBG {position:absolute;top:0;left:0;}
    #canvas {width:100%;height:100%;touch-action:none;object-fit:cover;}
    #canvasBG {filter:blur(5px);opacity:0;transition:opacity .3s;}
    #graph {width:200px;height:100px;right:0;top:0;z-index:20;background:rgba(0,0,0,0.5);}
    #ui{position:absolute;top:15px;left:15px;z-index:10;background:rgba(0,0,0,0.5);padding:10px;border-radius:8px;}
    .ui-item{font-size:18px;color:white;margin-bottom:5px;}
    #bpm{color:#ff4757;font-weight:bold;}
    #instructions{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;
      background:rgba(0,0,0,0.7);padding:15px;border-radius:10px;z-index:20;pointer-events:none;}
    .button-container{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);display:flex;gap:15px;z-index:10;}
    .button-container button{width:60px;height:60px;border-radius:50%;border:4px solid white;
      background:rgba(255,255,255,0.3);font-size:28px;cursor:pointer;display:flex;justify-content:center;align-items:center;}
    #capture-btn{background:#ff4757;}
    #gallery{position:absolute;bottom:100px;left:0;width:100%;height:90px;background:rgba(0,0,0,0.4);
      padding:5px;box-sizing:border-box;display:flex;align-items:center;gap:8px;overflow-x:auto;z-index:10;}
    #gallery img{height:100%;border-radius:5px;border:2px solid white;cursor:pointer;transition:transform .1s;}
    #gallery img:hover{transform:scale(1.05);}
  </style>
</head>
<body>
  <video id="canvasBG" muted playsinline autoplay></video>
  <canvas id="canvas"></canvas>
  <canvas id="graph"></canvas>
  <div id="ui">
    <div id="bpm" class="ui-item">BPM: ---</div>
    <div id="fval-display" class="ui-item">FÂÄ§: 4.0</div>
  </div>
  <div id="instructions">
    <p>ËÉåÈù¢„ÅÆ„Ç´„É°„É©„Å®„É©„Ç§„Éà„ÇíÊåá„Åß„Åù„Å£„Å®Ë¶Ü„Å£„Å¶„Åè„Å†„Åï„ÅÑ</p>
    <p>‚Üì</p>
    <p>‰∏ã„ÅÆ„É©„Ç§„Éà„Éú„Çø„É≥(üí°)„ÇíÊäº„Åó„Å¶Ë®àÊ∏¨„ÇíÈñãÂßã„Åó„Åæ„Åô</p>
  </div>
  <div id="gallery"></div>
  <div class="button-container">
    <button id="flash-btn">üí°</button>
    <button id="capture-btn">üì∏</button>
  </div>
<script>
let canvas=document.getElementById("canvas"),
    ctx=canvas.getContext("2d"),
    bgvid=document.getElementById("canvasBG"),
    graphC=document.getElementById("graph"),
    gctx=graphC.getContext("2d"),
    bpmText=document.getElementById("bpm"),
    fvalText=document.getElementById("fval-display"),
    instr=document.getElementById("instructions"),
    flashBtn=document.getElementById("flash-btn"),
    captureBtn=document.getElementById("capture-btn"),
    gallery=document.getElementById("gallery");

let videoTrack, fValue=4.0, bpm=0, avgBpm=75, redHistory=[],
    isMeasuring=false,isFlashOn=false,scale=1, lastPinch=0;

async function initCam(){
  background: try{}
  const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}}});
  bgvid.srcObject=stream;
  videoTrack=stream.getVideoTracks()[0];
  bgvid.onloadeddata=()=>{setup();requestAnimationFrame(loop)};
}
function setup(){
  canvas.width=bgvid.videoWidth; canvas.height=bgvid.videoHeight;
  graphC.width=200; graphC.height=100;
  window.onresize=()=>{canvas.width=bgvid.videoWidth;canvas.height=bgvid.videoHeight};
  canvas.onwheel=e=>{e.preventDefault();scale+=-e.deltaY*0.001;updF());},canvas.addEventListener("touchstart",e=>{if(e.touches.length===2)lastPinch=dist(e.touches[0],e.touches[1]);});
  canvas.addEventListener("touchmove",e=>{e.preventDefault();if(e.touches.length===2){const d=dist(e.touches[0],e.touches[1]);scale+= (d-lastPinch)*0.005;lastPinch=d;updF();}});
}
function updF(){scale=Math.max(0.25,Math.min(scale,4));fValue=16/scale/4;fvalText.innerText=`FÂÄ§: ${fValue.toFixed(1)}`;}
function dist(a,b){return Math.hypot(a.clientX-b.clientX,a.clientY-b.clientY);}

function loop(){
  ctx.globalAlpha=1;
  ctx.drawImage(bgvid,0,0,canvas.width,canvas.height);
  if(isMeasuring){
    const w=canvas.width/2-50,h=canvas.height/2-50;
    const frame=ctx.getImageData(w,h,100,100);
    let sum=0;
    for(let i=0;i<frame.data.length;i+=4) sum+=frame.data[i];
    redHistory.push({value:sum/(frame.data.length/4),time:Date.now()});
    drawGraph();
  }
  applyEffects();
  requestAnimationFrame(loop);
}

function drawGraph(){
  const data=redHistory.slice(-200).map(x=>x.value);
  const min=Math.min(...data),max=Math.max(...data);
  gctx.clearRect(0,0,200,100);gctx.beginPath();
  data.forEach((v,i)=>{const x=(i/data.length)*200, y=100-((v-min)/(max-min+1e-6))*100; i?gctx.lineTo(x,y):gctx.moveTo(x,y)});
  gctx.strokeStyle="#0f8";gctx.lineWidth=1.5;gctx.stroke();
}

function applyEffects(){
  const bright=bpm>avgBpm?0.8:1.2;
  ctx.globalAlpha=(4/fValue)*(bpm?bright:1);
}

function calcBPM(){
  if(redHistory.length<64)return 0;
  const vals=redHistory.map(x=>x.value), times=redHistory.map(x=>x.time);
  const duration=(times.pop()-times[0])/1e3;
  const mean=vals.reduce((a,b)=>a+b)/vals.length;
  const cent=vals.map(v=>v-mean); const std=Math.sqrt(cent.map(v=>v*v).reduce((a,b)=>a+b)/cent.length);
  if(std<0.5) return 0;
  const n=vals.length, re=new Array(n).fill(0), im=new Array(n).fill(0);
  for(let k=0;k<n;k++)for(let t=0;t<n;t++){const a=2*Math.PI*t*k/n;re[k]+=cent[t]*Math.cos(a);im[k]-=cent[t]*Math.sin(a);}
  const pwr=re.map((r,i)=>Math.sqrt(r*r+im[i]*im[i]));
  const res=1/duration;
  const peaks=pwr.map((p,i)=>({bpm:i*res*60,power:p})).filter(x=>x.bpm>=40&&x.bpm<=200);
  if(!peaks.length)return 0;
  const peak=peaks.reduce((a,b)=>a.power>b.power?a:b);
  return Math.round(peak.bpm);
}

flashBtn.onclick=async()=>{
  if(!videoTrack||isMeasuring)return;
  isFlashOn=!isFlashOn;
  try{await videoTrack.applyConstraints({advanced:[{torch:isFlashOn}]});}catch{}
  flashBtn.style.background=isFlashOn?"#ffdd59":"rgba(255,255,255,0.3)";
  if(isFlashOn){
    instr.style.display="none";
    isMeasuring=true; redHistory=[];
    bpmText.innerText="BPM: Ë®àÊ∏¨‰∏≠...";
    setTimeout(()=>{
      isMeasuring=false;
      const res=calcBPM();
      if(res<40||res>200){bpmText.innerText="BPM: Ê∏¨ÂÆöÂ§±Êïó"; bpm=0;}else{avgBpm=bpm=res; bpmText.innerText=`BPM: ${bpm}`;}
    },8000);
  } else {bpmText.innerText="BPM: ---"; isMeasuring=false;}
};

captureBtn.onclick=()=>{
  const tmp=document.createElement("canvas"),tc=tmp.getContext("2d");
  tmp.width=canvas.width;tmp.height=canvas.height;
  tc.globalAlpha=ctx.globalAlpha; tc.drawImage(canvas,0,0);
  const url=tmp.toDataURL("image/jpeg",0.9);
  const link=document.createElement("a"),img=document.createElement("img");
  link.href=img.src=url; link.download=`heart_f${fValue.toFixed(1)}_bpm${bpm||avgBpm}.jpg`;
  img.src=url; link.appendChild(img); gallery.appendChild(link); gallery.scrollLeft=gallery.scrollWidth;
};

initCam();
</script>
</body>
</html>
