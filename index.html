<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>Få€¤ï¼‹BPMã‚«ãƒ¡ãƒ©ï¼ˆç°¡æ˜“ç‰ˆï¼‰</title>
<style>
  html, body {
    margin: 0; padding: 0; height: 100%;
    background: #000;
    color: #fff;
    font-family: monospace;
    overflow: hidden;
  }
  #app {
    width: 100%;
    height: 100%;
    position: relative;
  }
  button {
    background: #222;
    border: 2px solid #0f8;
    border-radius: 8px;
    color: #0f8;
    font-size: 18px;
    padding: 10px 20px;
    cursor: pointer;
    user-select: none;
  }
  button:active {
    background: #0a5;
  }
  #fvalue-screen, #bpm-screen, #camera-screen {
    position: absolute;
    width: 100%;
    height: 100%;
    background: #111;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }
  #fvalue-circle {
    border: 4px solid #0f8;
    border-radius: 50%;
    margin: 20px 0;
    transition: width 0.3s ease, height 0.3s ease;
    pointer-events: none;
    user-select: none;
  }
  #fvalue-text {
    font-size: 48px;
    font-weight: bold;
    text-align: center;
  }
  #fvalue-slider {
    width: 60%;
    max-width: 320px;
  }
  #next-btn {
    margin-top: 30px;
    background: #0f8;
    border-color: #0a5;
    color: #000;
  }
  #bpm-input {
    font-size: 24px;
    width: 100px;
    text-align: center;
    border: 2px solid #0f8;
    border-radius: 6px;
    background: #222;
    color: #0f8;
  }
  #bpm-next-btn {
    margin-top: 30px;
    background: #0f8;
    border-color: #0a5;
    color: #000;
  }
  #camera-screen {
    display: none;
    background: black;
    position: relative;
  }
  #video, #photo-canvas {
    position: absolute;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  #capture-controls {
    position: absolute;
    bottom: 100px;
    width: 100%;
    display: flex;
    justify-content: center;
  }
  #capture-btn {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    border: 4px solid #0f8;
    background: rgba(0,255,136,0.3);
    font-size: 32px;
    color: #0f8;
    cursor: pointer;
    user-select: none;
  }
  #album {
    position: absolute;
    bottom: 15px;
    right: 15px;
    width: 260px;
    max-height: 180px;
    background: rgba(0,0,0,0.6);
    overflow-y: auto;
    border-radius: 12px;
    border: 2px solid #0f8;
    padding: 8px;
    box-sizing: border-box;
    font-size: 14px;
  }
  #album h3 {
    margin: 0 0 6px 0;
    color: #0f8;
  }
  .photo-entry {
    margin-bottom: 10px;
    border-bottom: 1px solid #0f8;
    padding-bottom: 6px;
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .photo-entry:last-child {
    border: none;
    margin-bottom: 0;
    padding-bottom: 0;
  }
  .photo-thumb {
    width: 48px;
    height: 36px;
    object-fit: cover;
    border: 1px solid #0f8;
    border-radius: 4px;
    flex-shrink: 0;
  }
  .photo-info {
    flex-grow: 1;
  }
  .photo-info div {
    line-height: 1.1;
  }
</style>
</head>
<body>
<div id="app">

  <!-- Få€¤è¨­å®šç”»é¢ -->
  <div id="fvalue-screen" role="main" aria-label="Få€¤è¨­å®šç”»é¢">
    <div id="fvalue-text" aria-live="polite">Få€¤: 10</div>
    <div id="fvalue-circle"></div>
    <input type="range" id="fvalue-slider" min="2" max="18" step="0.1" value="10" aria-label="Få€¤ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼" />
    <button id="next-btn" aria-label="æ¬¡ã¸">æ¬¡ã¸</button>
  </div>

  <!-- BPMæ¸¬å®šç”»é¢ -->
  <div id="bpm-screen" role="main" aria-label="BPMæ¸¬å®šç”»é¢" style="display:none;">
    <div>BPMï¼ˆã‚·ãƒ£ãƒƒã‚¿ãƒ¼ã‚¹ãƒ”ãƒ¼ãƒ‰ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
    <input type="number" id="bpm-input" min="40" max="180" value="80" aria-label="BPMå…¥åŠ›" />
    <button id="bpm-next-btn" aria-label="æ¬¡ã¸">æ¬¡ã¸</button>
  </div>

  <!-- æ’®å½±ç”»é¢ -->
  <div id="camera-screen" role="main" aria-label="æ’®å½±ç”»é¢">
    <video id="video" autoplay muted playsinline></video>
    <canvas id="photo-canvas"></canvas>
    <div id="capture-controls">
      <button id="capture-btn" aria-label="æ’®å½±">ğŸ“¸</button>
    </div>
    <div id="album" aria-live="polite" aria-label="æ’®å½±ã—ãŸå†™çœŸã®ã‚¢ãƒ«ãƒãƒ ">
      <h3>ã‚¢ãƒ«ãƒãƒ </h3>
    </div>
  </div>

</div>

<script>
(async () => {
  // å®šæ•°ãƒ»çŠ¶æ…‹
  const FVAL_MIN = 2;
  const FVAL_MAX = 18;
  let fValue = 10;
  let bpm = 80;
  let albumPhotos = [];

  // DOMå‚ç…§
  const fvalueScreen = document.getElementById("fvalue-screen");
  const bpmScreen = document.getElementById("bpm-screen");
  const cameraScreen = document.getElementById("camera-screen");
  const fvalueText = document.getElementById("fvalue-text");
  const fvalueCircle = document.getElementById("fvalue-circle");
  const fvalueSlider = document.getElementById("fvalue-slider");
  const nextBtn = document.getElementById("next-btn");
  const bpmInput = document.getElementById("bpm-input");
  const bpmNextBtn = document.getElementById("bpm-next-btn");
  const video = document.getElementById("video");
  const photoCanvas = document.getElementById("photo-canvas");
  const captureBtn = document.getElementById("capture-btn");
  const album = document.getElementById("album");

  const photoCtx = photoCanvas.getContext("2d");

  // ã‚«ãƒ¡ãƒ©èµ·å‹•
  let videoStream;
  try {
    videoStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
    video.srcObject = videoStream;
  } catch(e) {
    alert("ã‚«ãƒ¡ãƒ©èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ:" + e);
  }

  // Få€¤ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼é€£å‹•
  function updateFValueUI(val){
    fValue = Math.min(FVAL_MAX, Math.max(FVAL_MIN, val));
    fvalueText.textContent = `Få€¤: ${fValue.toFixed(1)}`;
    // å††ã®å¤§ãã•ï¼šå°ã•ã„Få€¤ã»ã©å¤§ããï¼ˆçµã‚Šé–‹æ”¾ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰
    // ã‚µã‚¤ã‚ºç¯„å›²120pxã€œ220px
    let size = 220 - ((fValue - FVAL_MIN) / (FVAL_MAX - FVAL_MIN)) * 100;
    size = Math.min(220, Math.max(120, size));
    fvalueCircle.style.width = size + "px";
    fvalueCircle.style.height = size + "px";
    // ãƒ¢ãƒ¤ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆå°ã•ã„Få€¤ã»ã©å¼·ã„ãƒ¢ãƒ¤ï¼‰
    // ã“ã“ã§ã¯å††ã®é€æ˜åº¦ã§è¡¨ç¾
    let opacity = 0.7 - (fValue - FVAL_MIN)/(FVAL_MAX - FVAL_MIN)*0.6;
    opacity = Math.min(0.7, Math.max(0.1, opacity));
    fvalueCircle.style.background = `rgba(0,255,136,${opacity})`;
  }
  updateFValueUI(fvalueSlider.value);

  fvalueSlider.addEventListener("input", e => {
    updateFValueUI(e.target.value);
  });

  // æ¬¡ã¸ãƒœã‚¿ãƒ³ã§BPMå…¥åŠ›ç”»é¢ã¸
  nextBtn.addEventListener("click", () => {
    fvalueScreen.style.display = "none";
    bpmScreen.style.display = "flex";
    bpmInput.value = 80;
  });

  // BPMå…¥åŠ›â†’æ¬¡ã¸ã§æ’®å½±ç”»é¢ã¸
  bpmNextBtn.addEventListener("click", () => {
    let val = parseInt(bpmInput.value, 10);
    if(isNaN(val) || val < 40 || val > 180){
      alert("BPMã¯40ã€œ180ã®æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }
    bpm = val;
    bpmScreen.style.display = "none";
    cameraScreen.style.display = "block";
    startCamera();
  });

  // æ’®å½±ç”»é¢ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºèª¿æ•´
  function resizeCanvas(){
    photoCanvas.width = video.videoWidth;
    photoCanvas.height = video.videoHeight;
    photoCanvas.style.width = video.clientWidth + "px";
    photoCanvas.style.height = video.clientHeight + "px";
  }

  // æ’®å½±æ™‚ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨ˆç®—
  function applyFilters(ctx, width, height){
    // Få€¤ã«ã‚ˆã‚‹ãƒ¢ãƒ¤(ã¼ã‹ã—ã¨æ˜åº¦ä½ä¸‹)
    // Få€¤å°ã•ã„ã»ã©ã¼ã‹ã—å¼·ãã€æš—ã
    // ç°¡æ˜“çš„ã«canvasã®globalAlphaã§èª¿æ•´ï¼ˆã¼ã‹ã—ã¯ç°¡å˜ã«ã§ããªã„ãŸã‚ï¼‰
    let blurAmount = (FVAL_MAX - fValue) / (FVAL_MAX - FVAL_MIN) * 4; // æœ€å¤§4pxã¼ã‹ã—æƒ³å®š
    let brightnessAdjust = 1 - ((FVAL_MAX - fValue) / (FVAL_MAX - FVAL_MIN)) * 0.3; // 0.7ã€œ1ã®æ˜åº¦
    ctx.filter = `blur(${blurAmount}px) brightness(${brightnessAdjust})`;

    // BPMã«ã‚ˆã‚‹æ˜ã‚‹ã•è£œæ­£
    // BPM80åŸºæº–
    if(bpm < 60){
      let brightFactor = 1 + (60 - bpm) * 0.02; // æœ€å¤§ +0.4
      ctx.filter += ` brightness(${brightFactor})`;
    } else if(bpm > 100){
      let darkFactor = 1 - (bpm - 100) * 0.02; // æœ€å¤§ 0.6
      ctx.filter += ` brightness(${darkFactor})`;
    }
  }

  // ã‚«ãƒ¡ãƒ©é–‹å§‹
  function startCamera(){
    video.play();
    video.addEventListener("loadedmetadata", () => {
      resizeCanvas();
    });
  }

  // æ’®å½±å‡¦ç†
  captureBtn.addEventListener("click", () => {
    if(video.videoWidth === 0 || video.videoHeight === 0) {
      alert("ã‚«ãƒ¡ãƒ©æº–å‚™ä¸­ã§ã™ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ãã ã•ã„");
      return;
    }
    photoCanvas.width = video.videoWidth;
    photoCanvas.height = video.videoHeight;
    photoCtx.clearRect(0, 0, photoCanvas.width, photoCanvas.height);

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®š
    photoCtx.save();
    applyFilters(photoCtx, photoCanvas.width, photoCanvas.height);

    // æç”»
    photoCtx.drawImage(video, 0, 0, photoCanvas.width, photoCanvas.height);
    photoCtx.restore();

    // ç”»åƒãƒ‡ãƒ¼ã‚¿ä½œæˆ
    const dataUrl = photoCanvas.toDataURL("image/png");

    // ã‚¢ãƒ«ãƒãƒ è¿½åŠ 
    addPhotoToAlbum(dataUrl);
  });

  // ã‚¢ãƒ«ãƒãƒ ã«è¿½åŠ 
  function addPhotoToAlbum(dataUrl){
    const now = new Date();
    const entry = document.createElement("div");
    entry.className = "photo-entry";

    const thumb = document.createElement("img");
    thumb.className = "photo-thumb";
    thumb.src = dataUrl;
    thumb.alt = `æ’®å½±ç”»åƒ Få€¤:${fValue.toFixed(1)} BPM:${bpm}`;

    const info = document.createElement("div");
    info.className = "photo-info";
    info.innerHTML =
      `<div>Få€¤: ${fValue.toFixed(1)}</div>` +
      `<div>BPM: ${bpm}</div>` +
      `<div>${now.toLocaleString()}</div>`;

    entry.appendChild(thumb);
    entry.appendChild(info);

    album.appendChild(entry);
    albumPhotos.push({dataUrl, fValue, bpm, date: now});
  }

})();
</script>
</body>
</html>
