<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>F-Shutter Heart Camera</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <style>
    body { 
      margin: 0; 
      overflow: hidden; 
      background: #000; 
      color: white; 
      font-family: monospace, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #canvas { 
      touch-action: none; 
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    #ui { 
      position: absolute; 
      top: 15px; 
      left: 15px; 
      z-index: 10; 
      background: rgba(0,0,0,0.5);
      padding: 10px;
      border-radius: 8px;
    }
    .ui-item { font-size: 18px; color: white; margin-bottom: 5px; }
    #bpm { color: #ff4757; font-weight: bold; }
    #instructions {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      background: rgba(0,0,0,0.7);
      padding: 15px;
      border-radius: 10px;
      z-index: 20;
    }
    .button-container {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 15px;
      z-index: 10;
    }
    .button-container button {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: 4px solid white;
      background: rgba(255, 255, 255, 0.3);
      font-size: 28px;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #capture-btn {
      background: #ff4757;
    }
  </style>
</head>
<body>

<div id="ui">
  <div id="bpm" class="ui-item">BPM: ---</div>
  <div id="fval-display" class="ui-item">Få€¤: 4.0</div>
</div>

<div id="instructions">
  <p>èƒŒé¢ã®ã‚«ãƒ¡ãƒ©ã¨ãƒ©ã‚¤ãƒˆã‚’<br>æŒ‡ã§ãã£ã¨è¦†ã£ã¦ãã ã•ã„</p>
  <p>â†“</p>
  <p>ä¸‹ã®ãƒ©ã‚¤ãƒˆãƒœã‚¿ãƒ³(ğŸ’¡)ã‚’æŠ¼ã—ã¦<br>è¨ˆæ¸¬ã‚’é–‹å§‹ã—ã¾ã™</p>
</div>

<canvas id="canvas"></canvas>

<div class="button-container">
  <button id="flash-btn">ğŸ’¡</button>
  <button id="capture-btn">ğŸ“¸</button>
</div>

<script>
let video, canvas, ctx;
let videoTrack;
let fValue = 4.0;
let bpm = 0;
let redValues = [];
let timestamps = [];
let scale = 1.0;
let lastPinchDist = 0;
let isFlashOn = false;

const bpmText = document.getElementById("bpm");
const fvalText = document.getElementById("fval-display");
const instructions = document.getElementById("instructions");
const flashBtn = document.getElementById("flash-btn");
const captureBtn = document.getElementById("capture-btn");

// --- åˆæœŸåŒ–å‡¦ç† ---
async function initCamera() {
  video = document.createElement("video");
  video.setAttribute("autoplay", true);
  video.setAttribute("playsinline", true);

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ 
      video: { 
        facingMode: "environment",
        width: { ideal: 1280 },
        height: { ideal: 720 }
      } 
    });
    video.srcObject = stream;
    // ãƒ©ã‚¤ãƒˆåˆ¶å¾¡ã®ãŸã‚ã«ãƒˆãƒ©ãƒƒã‚¯ã‚’ä¿æŒ
    const tracks = stream.getVideoTracks();
    if (tracks.length > 0) {
      videoTrack = tracks[0];
    }
  } catch (err) {
    alert("ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚«ãƒ¡ãƒ©åˆ©ç”¨ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚ã¾ãŸã€ã“ã®ãƒšãƒ¼ã‚¸ã¯HTTPSæ¥ç¶šã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚\n" + err);
    return;
  }

  video.addEventListener("loadeddata", () => {
    setupCanvas();
    requestAnimationFrame(draw);
  });
}

// --- ã‚­ãƒ£ãƒ³ãƒã‚¹ã¨æ“ä½œã®è¨­å®š ---
function setupCanvas() {
  canvas = document.getElementById("canvas");
  ctx = canvas.getContext("2d");
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  // PC: ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã§Få€¤å¤‰æ›´
  canvas.addEventListener("wheel", e => {
    e.preventDefault();
    scale += e.deltaY * -0.001;
    updateFValue();
  }, { passive: false });

  // ã‚¹ãƒãƒ›: ãƒ”ãƒ³ãƒæ“ä½œã§Få€¤å¤‰æ›´
  canvas.addEventListener("touchstart", e => {
    if (e.touches.length === 2) {
      lastPinchDist = dist(e.touches[0], e.touches[1]);
    }
  });

  canvas.addEventListener("touchmove", e => {
    e.preventDefault();
    if (e.touches.length === 2) {
      const currentDist = dist(e.touches[0], e.touches[1]);
      scale += (currentDist - lastPinchDist) * 0.005;
      lastPinchDist = currentDist;
      updateFValue();
    }
  }, { passive: false });
}

function updateFValue() {
  scale = Math.max(0.25, Math.min(scale, 4.0));
  fValue = 16.0 / scale / 4.0;
  fvalText.innerText = `Få€¤: ${fValue.toFixed(1)}`;
}

function dist(p1, p2) {
  return Math.sqrt(Math.pow(p1.clientX - p2.clientX, 2) + Math.pow(p1.clientY - p2.clientY, 2));
}

// --- æç”»ã¨BPMè¨ˆç®— ---
function draw() {
  // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ä¿ã£ã¦æ˜ åƒã‚’ä¸­å¤®ã«æç”»
  const videoRatio = video.videoWidth / video.videoHeight;
  const canvasRatio = canvas.width / canvas.height;
  let drawWidth, drawHeight, startX, startY;

  if (videoRatio > canvasRatio) { // æ¨ªé•·ã®æ˜ åƒ
    drawHeight = canvas.height;
    drawWidth = drawHeight * videoRatio;
    startX = (canvas.width - drawWidth) / 2;
    startY = 0;
  } else { // ç¸¦é•·ã®æ˜ åƒ
    drawWidth = canvas.width;
    drawHeight = drawWidth / videoRatio;
    startY = (canvas.height - drawHeight) / 2;
    startX = 0;
  }
  ctx.drawImage(video, startX, startY, drawWidth, drawHeight);

  if (isFlashOn) {
    // ä¸­å¤®ã®20x20ãƒ”ã‚¯ã‚»ãƒ«ã®å¹³å‡çš„ãªèµ¤è‰²ã‚’å–å¾—
    const frame = ctx.getImageData(canvas.width / 2 - 10, canvas.height / 2 - 10, 20, 20);
    let sumRed = 0;
    for (let i = 0; i < frame.data.length; i += 4) {
      sumRed += frame.data[i];
    }
    const avgRed = sumRed / (frame.data.length / 4);
    
    // ãƒ‡ãƒ¼ã‚¿ãŒæœ‰åŠ¹ãªå ´åˆã®ã¿BPMè¨ˆç®—
    if (!isNaN(avgRed)) {
        redValues.push(avgRed);
        timestamps.push(Date.now());
    }

    // ãƒ‡ãƒ¼ã‚¿ã‚’5ç§’åˆ†ï¼ˆ30fpsæ›ç®—ã§150ãƒ•ãƒ¬ãƒ¼ãƒ ï¼‰ã«åˆ¶é™
    if (redValues.length > 150) {
      redValues.shift();
      timestamps.shift();
    }
    
    if (redValues.length >= 60) {
      bpm = calcBPM(redValues, timestamps);
      if (bpm > 40 && bpm < 200) {
         bpmText.innerText = `BPM: ${bpm}`;
      } else {
         bpmText.innerText = `BPM: ---`;
      }
    }
  }

  // çµã‚Šã‚’è¡¨ç¾ã™ã‚‹UI
  ctx.fillStyle = "rgba(0,0,0,0.8)";
  ctx.beginPath();
  const outerRadius = Math.max(canvas.width, canvas.height);
  ctx.arc(canvas.width / 2, canvas.height / 2, outerRadius, 0, 2 * Math.PI);
  const innerRadius = 50 * scale; // Få€¤ã¨é€£å‹•
  ctx.arc(canvas.width / 2, canvas.height / 2, innerRadius, 0, 2 * Math.PI, true);
  ctx.fill();

  requestAnimationFrame(draw);
}

// ã‚ˆã‚Šãƒ­ãƒã‚¹ãƒˆãªBPMè¨ˆç®—ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
function calcBPM(signal, times) {
    if (signal.length < 2) return 0;

    // ä¿¡å·ã‚’å¹³æ»‘åŒ–ï¼ˆç§»å‹•å¹³å‡ï¼‰
    const smoothed = [];
    for (let i = 2; i < signal.length - 2; i++) {
        const avg = (signal[i-2] + signal[i-1] + signal[i] + signal[i+1] + signal[i+2]) / 5;
        smoothed.push(avg);
    }
    const smoothedTimes = times.slice(2, -2);
    
    const mean = smoothed.reduce((a, b) => a + b) / smoothed.length;
    
    // å¹³å‡ã‚ˆã‚Šé«˜ã„å€¤ã‚’æŒã¤éƒ¨åˆ†ã§ãƒ”ãƒ¼ã‚¯ã‚’æ¢ã™
    const peaks = [];
    for (let i = 1; i < smoothed.length - 1; i++) {
        if (smoothed[i] > mean && smoothed[i] > smoothed[i-1] && smoothed[i] > smoothed[i+1]) {
            peaks.push(smoothedTimes[i]);
        }
    }

    if (peaks.length < 2) return 0;

    const intervals = [];
    for (let i = 1; i < peaks.length; i++) {
        intervals.push(peaks[i] - peaks[i-1]);
    }
    
    // å¤–ã‚Œå€¤ã‚’é™¤å»ï¼ˆãƒ¡ãƒ‡ã‚£ã‚¢ãƒ³ã®Â±50%ï¼‰
    intervals.sort((a, b) => a - b);
    const median = intervals[Math.floor(intervals.length / 2)];
    const validIntervals = intervals.filter(interval => interval > median * 0.5 && interval < median * 1.5);

    if (validIntervals.length < 1) return 0;
    
    const avgInterval = validIntervals.reduce((a, b) => a + b) / validIntervals.length;
    
    if (isNaN(avgInterval) || avgInterval === 0) return 0;
    
    return Math.round(60000 / avgInterval);
}


// --- ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ ---
flashBtn.addEventListener("click", () => {
    if (!videoTrack) return;
    isFlashOn = !isFlashOn;
    videoTrack.applyConstraints({
      advanced: [{ torch: isFlashOn }]
    });
    flashBtn.style.background = isFlashOn ? "#ffdd59" : "rgba(255, 255, 255, 0.3)";
    if(isFlashOn) {
        instructions.style.display = 'none'; // ãƒ©ã‚¤ãƒˆã‚ªãƒ³ã§èª¬æ˜ã‚’æ¶ˆã™
    }
});

captureBtn.addEventListener("click", () => {
  // Få€¤ã¨BPMã§æ˜ã‚‹ã•ã‚’èª¿æ•´ã™ã‚‹
  const tempCanvas = document.createElement('canvas');
  const tempCtx = tempCanvas.getContext('2d');
  tempCanvas.width = canvas.width;
  tempCanvas.height = canvas.height;
  
  // ç¾åœ¨ã®æ˜ åƒã‚’ãã®ã¾ã¾æç”»
  tempCtx.drawImage(canvas, 0, 0);
  
  const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
  const data = imageData.data;
  
  // æ˜ã‚‹ã•ã®èª¿æ•´ä¿‚æ•° (BPMãŒ60ã®æ™‚ã‚’åŸºæº–)
  // Få€¤ãŒå°ã•ã„ï¼ˆæ˜ã‚‹ã„ï¼‰ã»ã©ã€BPMãŒé€Ÿã„ã»ã©ã€å†™çœŸã¯æš—ããªã‚‹
  const currentBpm = (bpm > 40 && bpm < 200) ? bpm : 60; // ä¸å®‰å®šãªBPMå€¤ã®å ´åˆã¯60ã‚’åŸºæº–ã¨ã™ã‚‹
  const factor = 2.0 / (fValue * (currentBpm / 60));

  for (let i = 0; i < data.length; i += 4) {
    data[i]   = Math.min(255, data[i] * factor);     // Red
    data[i+1] = Math.min(255, data[i+1] * factor); // Green
    data[i+2] = Math.min(255, data[i+2] * factor); // Blue
  }
  tempCtx.putImageData(imageData, 0, 0);

  // ç”»åƒã¨ã—ã¦ä¿å­˜
  const link = document.createElement('a');
  link.href = tempCanvas.toDataURL("image/jpeg", 0.9); // JPEGå½¢å¼ã§ä¿å­˜
  link.download = `heart_camera_f${fValue.toFixed(1)}_bpm${currentBpm}.jpg`;
  link.click();
});

// ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
initCamera();

</script>
</body>
</html>
