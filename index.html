<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>F-Shutter Heart Camera</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<style>
  body{margin:0;overflow:hidden;background:#000;color:#fff;font-family:monospace;}
  video, canvas{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;}
  #graph{position:absolute;top:0;right:0;width:200px;height:100px;background:rgba(0,0,0,0.5);z-index:10;}
  #ui{position:absolute;top:15px;left:15px;background:rgba(0,0,0,0.5);padding:10px;border-radius:8px;z-index:10;}
  .ui-item{font-size:18px;margin-bottom:5px;}
  #instructions{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.7);padding:15px;border-radius:10px;text-align:center;z-index:10;}
  .button-container{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);display:flex;gap:15px;z-index:10;}
  button{width:60px;height:60px;border-radius:50%;border:4px solid white;background:rgba(255,255,255,0.3);font-size:28px;cursor:pointer;}
  #capture-btn{background:#ff4757;}
  #gallery{position:absolute;bottom:100px;left:0;width:100%;height:90px;background:rgba(0,0,0,0.4);display:flex;align-items:center;overflow-x:auto;gap:8px;box-sizing:border-box;z-index:10;}
  #gallery img{height:100%;border:2px solid white;border-radius:5px;cursor:pointer;transition:transform .1s;}
  #gallery img:hover{transform:scale(1.05);}
</style>
</head>
<body>
  <video id="video" playsinline autoplay muted></video>
  <canvas id="canvas"></canvas>
  <canvas id="graph"></canvas>

  <div id="ui">
    <div id="bpm" class="ui-item">BPM: ---</div>
    <div id="fval" class="ui-item">FÂÄ§: 4.0</div>
  </div>
  <div id="instructions">
    <p>ËÉåÈù¢„Ç´„É°„É©„Å®„É©„Ç§„Éà„ÇíÊåá„ÅßË¶Ü„Å£„Å¶„Åè„Å†„Åï„ÅÑ</p><p>‚Üì</p><p>üí° „ÇíÊäº„Åó„Å¶Ë®àÊ∏¨ÈñãÂßã</p>
  </div>
  <div class="button-container">
    <button id="flash-btn">üí°</button>
    <button id="capture-btn">üì∏</button>
  </div>
  <div id="gallery"></div>

<script>
(async()=>{
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const graph = document.getElementById("graph");
  const bpmText = document.getElementById("bpm");
  const fvalText = document.getElementById("fval");
  const instr = document.getElementById("instructions");
  const flashBtn = document.getElementById("flash-btn");
  const capBtn = document.getElementById("capture-btn");
  const gallery = document.getElementById("gallery");
  const ctx = canvas.getContext("2d");
  const gctx = graph.getContext("2d");

  let videoTrack, scale=1,fValue=4,bpm=0,avgBpm=75;
  let measuring=false, history=[],lastPinch=0;

  try {
    const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
    video.srcObject = stream;
    videoTrack = stream.getVideoTracks()[0];
  } catch(err){
    alert("„Ç´„É°„É©Ëµ∑ÂãïÂ§±ÊïóÔºö"+err);
    return;
  }

  function resize(){
    canvas.width=video.videoWidth;
    canvas.height=video.videoHeight;
    graph.width=200;graph.height=100;
  }
  video.addEventListener("loadeddata",()=>{
    resize();
    requestAnimationFrame(loop);
  });
  window.addEventListener("resize", resize);

  function loop(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.filter = "none";
    ctx.globalAlpha = 1;
    ctx.drawImage(video,0,0,canvas.width,canvas.height);

    if(measuring){
      const s = 100;
      const x = canvas.width/2 - s/2, y = canvas.height/2 - s/2;
      const dat = ctx.getImageData(x,y,s,s).data;
      let sum=0;
      for(let i=0;i<dat.length;i+=4) sum += dat[i];
      history.push({v: sum/(dat.length/4),t:Date.now()});
      drawGraph();
    }

    const bright = bpm > avgBpm ? 0.7 : 1.3;
    ctx.globalAlpha = (4/fValue)*(measuring?1:bright);

    requestAnimationFrame(loop);
  }

  function drawGraph(){
    const arr = history.slice(-200).map(o=>o.v);
    const min=Math.min(...arr), max=Math.max(...arr);
    gctx.clearRect(0,0,200,100);
    gctx.beginPath();
    arr.forEach((v,i)=>{
      const x=i/arr.length*200;
      const y=100-((v-min)/(max-min+1e-6))*100;
      i===0?gctx.moveTo(x,y):gctx.lineTo(x,y);
    });
    gctx.strokeStyle="#0f8";gctx.lineWidth=1.5;gctx.stroke();
  }

  function calcBPM(){
    const h=history;
    if(h.length<60) return 0;
    const vals=h.map(o=>o.v), times=h.map(o=>o.t);
    const dur=(times[times.length-1]-times[0])/1000;
    if(dur<5) return 0;
    const mean=vals.reduce((a,b)=>a+b)/vals.length;
    const cen=vals.map(v=>v-mean);
    const std=Math.sqrt(cen.map(v=>v*v).reduce((a,b)=>a+b)/cen.length);
    if(std<0.5) return 0;

    const n=cen.length;
    const re=new Array(n).fill(0), im=new Array(n).fill(0);
    for(let k=0;k<n;k++)
      for(let t=0;t<n;t++){
        const ang=2*Math.PI*t*k/n;
        re[k]+=cen[t]*Math.cos(ang);
        im[k]-=cen[t]*Math.sin(ang);
      }
    const power=re.map((r,i)=>Math.hypot(r,im[i]));
    const freqRes=1/dur;
    const peaks=power.map((p,i)=>({bpm:i*freqRes*60,power:p}))
      .filter(o=>o.bpm>=40&&o.bpm<=200);
    if(!peaks.length) return 0;
    const peak=peaks.reduce((a,b)=>a.power>b.power?a:b);
    return Math.round(peak.bpm);
  }

  flashBtn.onclick = async ()=>{
    if(!videoTrack||measuring) return;
    measuring = true; history=[]; instr.style.display="none";
    bpmText.innerText="BPM: Ë®àÊ∏¨‰∏≠...";
    const cap = await videoTrack.applyConstraints({advanced:[{torch:true}]});
    setTimeout(async()=>{
      measuring=false;
      await videoTrack.applyConstraints({advanced:[{torch:false}]});
      const r = calcBPM();
      if(r<40||r>200) bpmText.innerText="BPM: Ê∏¨ÂÆöÂ§±Êïó";
      else { bpm=r; avgBpm=bpm; bpmText.innerText=`BPM: ${bpm}`; }
    },8000);
  };

  capBtn.onclick = ()=>{
    const tmp = document.createElement("canvas");
    tmp.width=canvas.width; tmp.height=canvas.height;
    const tc=tmp.getContext("2d");
    tc.globalAlpha = ctx.globalAlpha;
    tc.drawImage(canvas,0,0);
    const url=tmp.toDataURL("image/jpeg",0.9);
    const a=document.createElement("a"),img=document.createElement("img");
    a.href=url; a.download=`f${fValue.toFixed(1)}_bpm${bpm||avgBpm}.jpg`;
    img.src=url; a.appendChild(img); gallery.appendChild(a);
    gallery.scrollLeft=gallery.scrollWidth;
  };

  canvas.onwheel = e=>{
    e.preventDefault();
    scale += -e.deltaY*0.001;
    scale=Math.max(0.25,Math.min(scale,4));
    fValue = 16/scale/4;
    fvalText.innerText=`FÂÄ§: ${fValue.toFixed(1)}`;
  };

  canvas.addEventListener("touchstart",e=>{
    if(e.touches.length===2) lastPinch = Math.hypot(e.touches[0].clientX-e.touches[1].clientX, e.touches[0].clientY-e.touches[1].clientY);
  });
  canvas.addEventListener("touchmove",e=>{
    if(e.touches.length===2){
      const d = Math.hypot(e.touches[0].clientX-e.touches[1].clientX, e.touches[0].clientY-e.touches[1].clientY);
      scale += (d-lastPinch)*0.005;
      lastPinch = d;
      scale=Math.max(0.25,Math.min(scale,4));
      fValue = 16/scale/4;
      fvalText.innerText=`FÂÄ§: ${fValue.toFixed(1)}`;
    }
  });
})();
</script>
</body>
</html>
