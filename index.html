<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>F値＋BPMカメラ</title>
<style>
  html, body {
    margin: 0; padding: 0; height: 100%;
    background: #000;
    color: #fff;
    font-family: monospace;
    overflow: hidden;
  }
  #app {
    width: 100%;
    height: 100%;
    position: relative;
  }
  button {
    background: #222;
    border: 2px solid #0f8;
    border-radius: 8px;
    color: #0f8;
    font-size: 18px;
    padding: 10px 20px;
    cursor: pointer;
    user-select: none;
  }
  button:active {
    background: #0a5;
  }
  #fvalue-screen, #bpm-screen, #camera-screen {
    position: absolute;
    width: 100%;
    height: 100%;
    background: #111;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }
  #fvalue-circle {
    border: 4px solid #0f8;
    border-radius: 50%;
    margin: 20px 0;
    transition: width 0.3s ease, height 0.3s ease;
    pointer-events: none;
    user-select: none;
  }
  #fvalue-text {
    font-size: 48px;
    font-weight: bold;
    text-align: center;
  }
  #fvalue-slider {
    width: 60%;
    max-width: 320px;
  }
  #next-btn {
    margin-top: 30px;
    background: #0f8;
    border-color: #0a5;
    color: #000;
  }
  #bpm-instructions {
    margin-bottom: 20px;
    font-size: 20px;
    max-width: 320px;
    text-align: center;
  }
  #bpm-status {
    font-size: 36px;
    margin-bottom: 30px;
  }
  #bpm-next-btn {
    margin-top: 30px;
    background: #0f8;
    border-color: #0a5;
    color: #000;
    display: none;
  }
  #camera-screen {
    display: none;
    background: black;
    position: relative;
  }
  #video, #photo-canvas {
    position: absolute;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  #capture-controls {
    position: absolute;
    bottom: 100px;
    width: 100%;
    display: flex;
    justify-content: center;
  }
  #capture-btn {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    border: 4px solid #0f8;
    background: rgba(0,255,136,0.3);
    font-size: 32px;
    color: #0f8;
    cursor: pointer;
    user-select: none;
  }
  #album {
    position: absolute;
    bottom: 15px;
    right: 15px;
    width: 260px;
    max-height: 180px;
    background: rgba(0,0,0,0.6);
    overflow-y: auto;
    border-radius: 12px;
    border: 2px solid #0f8;
    padding: 8px;
    box-sizing: border-box;
    font-size: 14px;
  }
  #album h3 {
    margin: 0 0 6px 0;
    color: #0f8;
  }
  .photo-entry {
    margin-bottom: 10px;
    border-bottom: 1px solid #0f8;
    padding-bottom: 6px;
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .photo-entry:last-child {
    border: none;
    margin-bottom: 0;
    padding-bottom: 0;
  }
  .photo-thumb {
    width: 48px;
    height: 36px;
    object-fit: cover;
    border: 1px solid #0f8;
    border-radius: 4px;
    flex-shrink: 0;
  }
  .photo-info {
    flex-grow: 1;
  }
  .photo-info div {
    line-height: 1.1;
  }
</style>
</head>
<body>
<div id="app">

  <!-- F値設定画面 -->
  <div id="fvalue-screen" role="main" aria-label="F値設定画面">
    <div id="fvalue-text" aria-live="polite">F値: 10</div>
    <div id="fvalue-circle"></div>
    <input type="range" id="fvalue-slider" min="2" max="18" step="0.1" value="10" aria-label="F値スライダー" />
    <button id="next-btn" aria-label="次へ">次へ</button>
  </div>

  <!-- BPM測定画面 -->
  <div id="bpm-screen" role="main" aria-label="BPM測定画面" style="display:none;">
    <div id="bpm-instructions">
      指先をカメラにかざして脈拍を測定してください。<br>
      数秒かかります。
    </div>
    <div id="bpm-status" aria-live="polite">測定中…</div>
    <button id="bpm-next-btn" aria-label="次へ">次へ</button>
  </div>

  <!-- 撮影画面 -->
  <div id="camera-screen" role="main" aria-label="撮影画面">
    <video id="video" autoplay muted playsinline></video>
    <canvas id="photo-canvas"></canvas>
    <div id="capture-controls">
      <button id="capture-btn" aria-label="撮影">📸</button>
    </div>
    <div id="album" aria-live="polite" aria-label="撮影した写真のアルバム">
      <h3>アルバム</h3>
    </div>
  </div>

</div>

<script>
(async () => {
  // 定数・状態
  const FVAL_MIN = 2;
  const FVAL_MAX = 18;
  let fValue = 10;
  let bpm = 80;
  let albumPhotos = [];

  // DOM参照
  const fvalueScreen = document.getElementById("fvalue-screen");
  const bpmScreen = document.getElementById("bpm-screen");
  const cameraScreen = document.getElementById("camera-screen");
  const fvalueText = document.getElementById("fvalue-text");
  const fvalueCircle = document.getElementById("fvalue-circle");
  const fvalueSlider = document.getElementById("fvalue-slider");
  const nextBtn = document.getElementById("next-btn");
  const bpmInstructions = document.getElementById("bpm-instructions");
  const bpmStatus = document.getElementById("bpm-status");
  const bpmNextBtn = document.getElementById("bpm-next-btn");
  const video = document.getElementById("video");
  const photoCanvas = document.getElementById("photo-canvas");
  const captureBtn = document.getElementById("capture-btn");
  const album = document.getElementById("album");

  const photoCtx = photoCanvas.getContext("2d");

  // カメラ起動（動画ストリームは撮影画面用）
  let videoStream;
  try {
    videoStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
    video.srcObject = videoStream;
  } catch(e) {
    alert("カメラ起動に失敗しました:" + e);
  }

  // F値スライダー連動
  function updateFValueUI(val){
    fValue = Math.min(FVAL_MAX, Math.max(FVAL_MIN, val));
    fvalueText.textContent = `F値: ${fValue.toFixed(1)}`;
    // 円の大きさ：小さいF値ほど大きく（絞り開放イメージ）
    // サイズ範囲120px〜220px
    let size = 220 - ((fValue - FVAL_MIN) / (FVAL_MAX - FVAL_MIN)) * 100;
    size = Math.min(220, Math.max(120, size));
    fvalueCircle.style.width = size + "px";
    fvalueCircle.style.height = size + "px";
    // モヤフィルター（小さいF値ほど強いモヤ）
    // ここでは円の透明度で表現
    let opacity = 0.7 - (fValue - FVAL_MIN)/(FVAL_MAX - FVAL_MIN)*0.6;
    opacity = Math.min(0.7, Math.max(0.1, opacity));
    fvalueCircle.style.background = `rgba(0,255,136,${opacity})`;
  }
  updateFValueUI(fvalueSlider.value);

  fvalueSlider.addEventListener("input", e => {
    updateFValueUI(e.target.value);
  });

  // 次へボタンでBPM入力画面へ
  nextBtn.addEventListener("click", () => {
    fvalueScreen.style.display = "none";
    bpmScreen.style.display = "flex";
    bpmStatus.textContent = "測定中…";
    bpmNextBtn.style.display = "none";
    startBpmMeasurement();
  });

  // BPM自動測定関連

  let bpmValues = [];
  let lastBpm = null;
  let measuring = false;

  const canvasForBpm = document.createElement("canvas");
  const ctxForBpm = canvasForBpm.getContext("2d");

  async function startBpmMeasurement() {
    measuring = true;
    bpmValues = [];
    lastBpm = null;

    // 小さい映像サイズで処理軽減
    canvasForBpm.width = 100;
    canvasForBpm.height = 100;

    if (!videoStream) {
      try {
        videoStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
        video.srcObject = videoStream;
      } catch(e) {
        alert("カメラ起動に失敗しました:" + e);
        return;
      }
    }

    measurePulse();
  }

  // 脈拍測定用タイマーとデータ
  let pulseTimestamps = [];
  let lastBrightness = null;
  let pulseDetectedTimes = [];

  function measurePulse(){
    if(!measuring) return;

    ctxForBpm.drawImage(video, 0, 0, canvasForBpm.width, canvasForBpm.height);
    const frame = ctxForBpm.getImageData(0,0,canvasForBpm.width,canvasForBpm.height);
    // 指先の赤色成分平均を計算
    let sumR = 0;
    for(let i=0; i<frame.data.length; i+=4){
      sumR += frame.data[i];
    }
    const avgR = sumR / (frame.data.length/4);

    // 簡易ピーク検出（赤色の変動で脈拍を検出）
    if(lastBrightness !== null){
      if(avgR < lastBrightness * 0.95){ // 明度が少し下がった＝脈拍ピーク？（指をかざした状態想定）
        let now = performance.now();
        if(pulseTimestamps.length > 0){
          let lastTime = pulseTimestamps[pulseTimestamps.length-1];
          let diff = now - lastTime;
          if(diff > 300 && diff < 2000){ // 間隔のバラツキ防止
            pulseDetectedTimes.push(now);
            if(pulseDetectedTimes.length > 5){
              pulseDetectedTimes.shift();
            }
            // BPM計算（1分/平均間隔）
            let intervals = [];
            for(let i=1; i<pulseDetectedTimes.length; i++){
              intervals.push(pulseDetectedTimes[i] - pulseDetectedTimes[i-1]);
            }
            let avgInterval = intervals.reduce((a,b) => a+b,0)/intervals.length;
            let newBpm = Math.round(60000/avgInterval);
            if(newBpm >= 40 && newBpm <= 180){
              bpm = newBpm;
              bpmStatus.textContent = `BPM: ${bpm}`;
              bpmNextBtn.style.display = "inline-block";
              lastBpm = bpm;
            }
          }
        }
        pulseTimestamps.push(now);
      }
    }
    lastBrightness = avgR;

    // 継続測定（約30fps）
    requestAnimationFrame(measurePulse);
  }

  // BPM画面の次へで撮影画面へ
  bpmNextBtn.addEventListener("click", () => {
    measuring = false;
    bpmScreen.style.display = "none";
    cameraScreen.style.display = "block";
    startCamera();
  });

  // 撮影画面のキャンバスサイズ調整
  function resizeCanvas(){
    photoCanvas.width = video.videoWidth;
    photoCanvas.height = video.videoHeight;
    photoCanvas.style.width = video.clientWidth + "px";
    photoCanvas.style.height = video.clientHeight + "px";
  }

  // 撮影時のフィルター計算
  function applyFilters(ctx, width, height){
    // F値によるモヤ(ぼかしと明度低下)
    // F値小さいほどぼかし強く、暗く
    // 簡易的にcanvasのglobalAlphaで調整（ぼかしは簡単にできないため）
    let blurAmount = (FVAL_MAX - fValue) / (FVAL_MAX - FVAL_MIN) * 4; // 最大4pxぼかし想定
    let brightnessAdjust = 1 - ((FVAL_MAX - fValue) / (FVAL_MAX - FVAL_MIN)) * 0.3; // 0.7〜1の明度
    ctx.filter = `blur(${blurAmount}px) brightness(${brightnessAdjust})`;

    // BPMによる明るさ補正
    // BPM80基準
    if(bpm < 60){
      let brightFactor = 1 + (60 - bpm) * 0.02; // 最大 +0.4
      ctx.filter += ` brightness(${brightFactor})`;
    } else if(bpm > 100){
      let darkFactor = 1 - (bpm - 100) * 0.02; // 最大 0.6
      ctx.filter += ` brightness(${darkFactor})`;
    }
  }

  // カメラ開始
  function startCamera(){
    video.play();
    video.addEventListener("loadedmetadata", () => {
      resizeCanvas();
    });
  }

  // 撮影処理
  captureBtn.addEventListener("click", () => {
    if(video.videoWidth === 0 || video.videoHeight === 0) {
      alert("カメラ準備中です。しばらく待ってください");
      return;
    }
    photoCanvas.width = video.videoWidth;
    photoCanvas.height = video.videoHeight;
    photoCtx.clearRect(0, 0, photoCanvas.width, photoCanvas.height);

    // フィルター設定
    photoCtx.save();
    applyFilters(photoCtx, photoCanvas.width, photoCanvas.height);

    photoCtx.drawImage(video, 0, 0, photoCanvas.width, photoCanvas.height);

    photoCtx.restore();

    // 画像データ取得
    const dataUrl = photoCanvas.toDataURL("image/jpeg", 0.9);

    addPhotoToAlbum(dataUrl, fValue, bpm);
  });

  // アルバムに写真追加
  function addPhotoToAlbum(dataUrl, fValue, bpm){
    const entry = document.createElement("div");
    entry.className = "photo-entry";

    const thumb = document.createElement("img");
    thumb.className = "photo-thumb";
    thumb.src = dataUrl;

    const info = document.createElement("div");
    info.className = "photo-info";

    const now = new Date();

    info.innerHTML =
      `<div>F値: ${fValue.toFixed(1)}</div>` +
      `<div>BPM: ${bpm}</div>` +
      `<div>${now.toLocaleString()}</div>`;

    entry.appendChild(thumb);
    entry.appendChild(info);

    album.appendChild(entry);
    albumPhotos.push({dataUrl, fValue, bpm, date: now});
  }

})();
</script>
</body>
</html>
