<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>F-Shutter Heart Camera</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #000;
      color: #fff;
      font-family: sans-serif;
      touch-action: none;
    }
    video, #canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 1;
    }
    #info-box, #album-button, #center-circle, #graph-container, #shutter-button, #start-bpm-button {
      z-index: 10;
      position: absolute;
    }
    #info-box {
      top: 20px;
      left: 20px;
      border: 2px solid white;
      background: rgba(0, 0, 0, 0.3);
      padding: 10px;
      border-radius: 5px;
      font-size: 16px;
    }
    #album-button {
      bottom: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid white;
      padding: 10px;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
    }
    #gallery {
      display: none;
      flex-wrap: wrap;
      gap: 10px;
      position: absolute;
      bottom: 80px;
      left: 20px;
      max-width: 80vw;
      z-index: 10;
      background: rgba(0,0,0,0.8);
      padding: 10px;
      border-radius: 8px;
    }
    .entry {
      background: #222;
      border: 1px solid #fff;
      padding: 5px;
      border-radius: 8px;
      width: 80px;
      color: #fff;
      font-size: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .entry img {
      width: 100%;
      border-radius: 4px;
      margin-bottom: 4px;
    }
    .entry .meta {
      text-align: center;
      line-height: 1.2;
    }
    #center-circle {
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border: 3px solid white;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 24px;
      font-weight: bold;
      user-select: none;
      transition: border-color 0.3s, width 0.3s, height 0.3s;
    }
    #graph-container {
      top: 50%;
      right: 15px;
      transform: translateY(-50%);
      width: 120px;
      height: 250px;
    }
    #graph {
      width: 100%;
      height: 100%;
    }
    #shutter-button {
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 60px;
      background-color: red;
      border-radius: 50%;
      border: 4px solid white;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      cursor: pointer;
    }
    #start-bpm-button {
      top: 20px;
      right: 20px;
      background: #0f8;
      color: #000;
      font-weight: bold;
      padding: 10px;
      border-radius: 6px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <video id="video" autoplay muted playsinline></video>
  <canvas id="canvas"></canvas>
  <div id="info-box">F: <span id="f-value">---</span><br>BPM: <span id="bpm-value">---</span></div>
  <div id="album-button">アルバム</div>
  <div id="gallery"></div>
  <div id="center-circle">心のF値</div>
  <div id="graph-container"><canvas id="graph"></canvas></div>
  <div id="shutter-button"></div>
  <div id="start-bpm-button">BPM測定</div>

<script>
(async () => {
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  const fValueText = document.getElementById("f-value");
  const bpmValueText = document.getElementById("bpm-value");
  const centerCircle = document.getElementById("center-circle");
  const shutterButton = document.getElementById("shutter-button");
  const gallery = document.getElementById("gallery");
  const albumButton = document.getElementById("album-button");
  const startBpmButton = document.getElementById("start-bpm-button");
  const graph = document.getElementById("graph");
  const gctx = graph.getContext("2d");

  let fValue = 4.0;
  let bpm = 0;
  let measuring = false;
  let history = [];
  let bpmTimer;

  const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
  video.srcObject = stream;

  function resize() {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    graph.width = graph.clientWidth;
    graph.height = graph.clientHeight;
  }

  video.addEventListener("loadeddata", () => {
    resize();
    updateFvalUI(fValue);
    requestAnimationFrame(loop);
  });

  function updateFvalUI(newFval) {
    const minF = 1.0, maxF = 16.0;
    fValue = Math.min(maxF, Math.max(minF, newFval));
    fValueText.textContent = fValue.toFixed(1);
    const size = 300 - ((fValue - 1.0) / 15) * 150;
    centerCircle.style.width = `${size}px`;
    centerCircle.style.height = `${size}px`;
  }

  let initialPinch = null;
  window.addEventListener("touchmove", e => {
    if (e.touches.length === 2) {
      e.preventDefault();
      const dx = e.touches[0].clientX - e.touches[1].clientX;
      const dy = e.touches[0].clientY - e.touches[1].clientY;
      const dist = Math.hypot(dx, dy);
      if (initialPinch != null) {
        const diff = dist - initialPinch;
        updateFvalUI(fValue - diff * 0.01);
      }
      initialPinch = dist;
    }
  }, { passive: false });
  window.addEventListener("touchend", () => { initialPinch = null });

  function startBPMMeasurement() {
    measuring = true;
    history = [];
    bpmValueText.textContent = "測定中...";
    if (bpmTimer) clearTimeout(bpmTimer);
    bpmTimer = setTimeout(() => {
      measuring = false;
      bpm = calculateBPM();
      bpmValueText.textContent = bpm > 0 ? Math.round(bpm) : "---";
    }, 8000);
  }

  function calculateBPM() {
    if (history.length < 2) return 0;
    const times = history.map(d => d.t);
    const values = history.map(d => d.v);
    const mean = values.reduce((a,b)=>a+b)/values.length;
    const peaks = [];
    for (let i = 1; i < values.length - 1; i++) {
      if (values[i] > mean && values[i] > values[i-1] && values[i] > values[i+1]) {
        peaks.push(times[i]);
      }
    }
    if (peaks.length < 2) return 0;
    const intervals = peaks.slice(1).map((t,i) => t - peaks[i]);
    const avgInterval = intervals.reduce((a,b)=>a+b)/intervals.length;
    return 60000 / avgInterval;
  }

  function loop() {
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    if (measuring) {
      const size = 100;
      const x = canvas.width/2 - size/2;
      const y = canvas.height/2 - size/2;
      const data = ctx.getImageData(x, y, size, size).data;
      let sum = 0;
      for (let i = 0; i < data.length; i += 4) sum += data[i];
      const avg = sum / (data.length / 4);
      history.push({ v: avg, t: Date.now() });
      if (history.length > 300) history.shift();
    }
    requestAnimationFrame(loop);
  }

  shutterButton.addEventListener("click", () => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if (fValue < 10) ctx.filter = 'blur(3px)';
    else ctx.filter = 'none';
    ctx.globalAlpha = bpm > 80 ? 0.7 : 1.0;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    ctx.filter = 'none';
    ctx.globalAlpha = 1.0;

    const url = canvas.toDataURL("image/jpeg", 0.9);
    const entry = document.createElement("div");
    entry.className = "entry";
    entry.innerHTML = `
      <img src="${url}" />
      <div class="meta">
        F${fValue.toFixed(1)}<br>
        BPM ${Math.round(bpm)}<br>
        ${new Date().toLocaleTimeString()}
      </div>
    `;
    gallery.appendChild(entry);
  });

  albumButton.addEventListener("click", () => {
    gallery.style.display = gallery.style.display === "flex" ? "none" : "flex";
  });

  startBpmButton.addEventListener("click", startBPMMeasurement);
})();
</script>
</body>
</html>
