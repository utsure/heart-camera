function computeFilters(fValue, bpm) {
  // ぼかし量：F値が10以下ならぼかし、それ以上はぼかしなし
  const blurPx = fValue <= 10 ? (10 - fValue) * 1.5 : 0;

  // BPMによるカラー（青系 or 赤系）
  // BPMが80以下 → 青系、80以上 → 赤系グラデーション
  let colorFilter = '';
  if (bpm <= 80) {
    // 青系（青色の強さをbpmで調整）
    const blueAmount = 1 - bpm / 80; // 0〜1
    const bluePercent = Math.min(Math.max(blueAmount, 0), 1) * 100;
    colorFilter = `drop-shadow(0 0 10px rgba(0,0,255,${blueAmount.toFixed(2)}))`;
  } else {
    // 赤系（80〜最大150くらいで強くなるイメージ）
    const redAmount = Math.min((bpm - 80) / 70, 1);
    colorFilter = `drop-shadow(0 0 10px rgba(255,0,0,${redAmount.toFixed(2)}))`;
  }

  return `blur(${blurPx}px) ${colorFilter}`;
}

function loop() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  // フィルター適用
  ctx.filter = computeFilters(fValue, bpm);
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  if (measuring) {
    const size = 100;
    const x = canvas.width / 2 - size / 2;
    const y = canvas.height / 2 - size / 2;
    const data = ctx.getImageData(x, y, size, size).data;
    let sum = 0;
    for (let i = 0; i < data.length; i += 4) sum += data[i];
    const avg = sum / (data.length / 4);
    history.push({ v: avg, t: Date.now() });
    if (history.length > 512) history.shift();
    drawGraph();
  }
  requestAnimationFrame(loop);
}

document.getElementById("shutter-button").onclick = () => {
  const tmp = document.createElement("canvas");
  tmp.width = canvas.width;
  tmp.height = canvas.height;
  const tc = tmp.getContext("2d");

  // 撮影時も同じフィルターをかける
  tc.filter = computeFilters(fValue, bpm);
  tc.drawImage(canvas, 0, 0);

  const url = tmp.toDataURL("image/jpeg", 0.9);
  const entry = document.createElement("div");
  entry.className = "entry";
  const img = document.createElement("img");
  img.src = url;
  const meta = document.createElement("div");
  meta.className = "meta";
  const now = new Date();
  meta.textContent = `F${fValue.toFixed(1)}\n${bpm} BPM\n${now.toLocaleString()}`;
  entry.appendChild(img);
  entry.appendChild(meta);
  gallery.appendChild(entry);

  // LocalStorageにも保存
  saveToLocalStorage(url, fValue, bpm, now);
};

function saveToLocalStorage(url, fVal, bpmVal, date) {
  let album = JSON.parse(localStorage.getItem("fshutter_album") || "[]");
  album.push({
    url,
    fVal,
    bpmVal,
    date: date.toISOString(),
  });
  localStorage.setItem("fshutter_album", JSON.stringify(album));
}

// 起動時にLocalStorageから復元する処理も加えてください。
