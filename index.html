<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>FÂÄ§ÔºãBPM„Ç´„É°„É©</title>
<style>
  html, body {
    margin: 0; padding: 0; height: 100%;
    background: #000;
    color: #fff;
    font-family: monospace;
    overflow: hidden;
  }
  #app {
    width: 100%;
    height: 100%;
    position: relative;
  }
  /* ÂÖ±ÈÄö„Éú„Çø„É≥ */
  button {
    background: #222;
    border: 2px solid #fff;
    border-radius: 8px;
    color: #fff;
    font-size: 18px;
    padding: 10px 20px;
    cursor: pointer;
    user-select: none;
  }
  button:active {
    background: #555;
  }
  /* --- FÂÄ§Ë®≠ÂÆöÁîªÈù¢ --- */
  #fvalue-screen {
    position: absolute;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: #111;
  }
  #fvalue-circle {
    width: 220px;
    height: 220px;
    border: 4px solid #0f8;
    border-radius: 50%;
    position: relative;
    touch-action: none;
    display: flex;
    justify-content: center;
    align-items: center;
    user-select: none;
  }
  #fvalue-text {
    font-size: 48px;
    font-weight: bold;
    pointer-events: none;
    user-select: none;
  }
  #fvalue-instruction {
    margin: 20px 0 30px 0;
    font-size: 18px;
    color: #0f8;
  }
  #next-btn {
    margin-top: 30px;
    background: #0f8;
    border-color: #0a5;
    color: #000;
  }

  /* --- BPMÊ∏¨ÂÆöÁîªÈù¢ --- */
  #bpm-screen {
    position: absolute;
    width: 100%;
    height: 100%;
    background: #111;
    display: none;
    flex-direction: column;
    align-items: center;
    padding-top: 50px;
    user-select: none;
  }
  #bpm-status {
    font-size: 20px;
    margin-bottom: 20px;
    color: #0f8;
  }
  #bpm-start-btn {
    font-size: 20px;
    padding: 12px 30px;
    background: #0f8;
    border-color: #0a5;
    color: #000;
    cursor: pointer;
  }
  #bpm-graph {
    width: 300px;
    height: 120px;
    background: #000;
    border: 2px solid #0f8;
    margin-top: 25px;
  }
  #bpm-info {
    margin-top: 12px;
    font-size: 16px;
    color: #0f8;
  }
  #bpm-next-btn {
    margin-top: 40px;
    background: #0f8;
    border-color: #0a5;
    color: #000;
    font-size: 20px;
    padding: 10px 30px;
    display: none;
  }

  /* --- ÊíÆÂΩ±ÁîªÈù¢ --- */
  #camera-screen {
    position: absolute;
    width: 100%;
    height: 100%;
    background: black;
    display: none;
    user-select: none;
  }
  #video, #photo-canvas {
    position: absolute;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  #capture-controls {
    position: absolute;
    bottom: 100px;
    width: 100%;
    display: flex;
    justify-content: center;
    gap: 30px;
    pointer-events: auto;
  }
  #capture-btn {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    border: 4px solid #0f8;
    background: rgba(0,255,136,0.3);
    font-size: 32px;
    color: #0f8;
    cursor: pointer;
    user-select: none;
  }

  /* --- „Ç¢„É´„Éê„É†UI --- */
  #album {
    position: absolute;
    bottom: 15px;
    right: 15px;
    width: 260px;
    max-height: 180px;
    background: rgba(0,0,0,0.6);
    overflow-y: auto;
    border-radius: 12px;
    border: 2px solid #0f8;
    padding: 8px;
    box-sizing: border-box;
    font-size: 14px;
  }
  #album h3 {
    margin: 0 0 6px 0;
    color: #0f8;
  }
  .photo-entry {
    margin-bottom: 10px;
    border-bottom: 1px solid #0f8;
    padding-bottom: 6px;
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .photo-entry:last-child {
    border: none;
    margin-bottom: 0;
    padding-bottom: 0;
  }
  .photo-thumb {
    width: 48px;
    height: 36px;
    object-fit: cover;
    border: 1px solid #0f8;
    border-radius: 4px;
    flex-shrink: 0;
  }
  .photo-info {
    flex-grow: 1;
  }
  .photo-info div {
    line-height: 1.1;
  }

</style>
</head>
<body>
<div id="app">

  <!-- FÂÄ§Ë®≠ÂÆöÁîªÈù¢ -->
  <div id="fvalue-screen">
    <div id="fvalue-circle" aria-label="FÂÄ§Ë®≠ÂÆöUI" role="slider" aria-valuemin="2" aria-valuemax="18" aria-valuenow="10" tabindex="0">
      <div id="fvalue-text">10</div>
    </div>
    <div id="fvalue-instruction">„Éî„É≥„ÉÅ„Ç§„É≥„Éª„Ç¢„Ç¶„Éà„ÅßFÂÄ§„ÇíË™øÊï¥„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
    <button id="next-btn" aria-label="Ê¨°„Å∏">Ê¨°„Å∏</button>
  </div>

  <!-- BPMÊ∏¨ÂÆöÁîªÈù¢ -->
  <div id="bpm-screen" role="main" aria-live="polite">
    <div id="bpm-status">BPM: ---</div>
    <button id="bpm-start-btn">üí° „É©„Ç§„Éà„ÇíÊäº„Åó„Å¶Ë®àÊ∏¨ÈñãÂßã</button>
    <canvas id="bpm-graph"></canvas>
    <div id="bpm-info">ÁîªÈù¢„Å´„É©„Ç§„Éà„ÇíÂΩì„Å¶„Å¶Êåá„ÅßË¶Ü„Å£„Å¶„Åè„Å†„Åï„ÅÑ</div>
    <button id="bpm-next-btn">Ê¨°„Å∏</button>
  </div>

  <!-- ÊíÆÂΩ±ÁîªÈù¢ -->
  <div id="camera-screen" role="main">
    <video id="video" autoplay muted playsinline></video>
    <canvas id="photo-canvas"></canvas>
    <div id="capture-controls">
      <button id="capture-btn" aria-label="ÊíÆÂΩ±">üì∏</button>
    </div>
    <div id="album" aria-live="polite" aria-label="ÊíÆÂΩ±„Åó„ÅüÂÜôÁúü„ÅÆ„Ç¢„É´„Éê„É†">
      <h3>„Ç¢„É´„Éê„É†</h3>
      <!-- „Åì„Åì„Å´ÂÜôÁúü„ÅåËøΩÂä†„Åï„Çå„Çã -->
    </div>
  </div>

</div>

<script>
(async () => {
  // --- ÂÆöÊï∞„ÉªÁä∂ÊÖã ---
  const FVAL_MIN = 2;
  const FVAL_MAX = 18;
  let fValue = 10; // ÂàùÊúüÂÄ§
  let bpm = 0;
  let avgBpm = 80;
  let measuring = false;
  let bpmHistory = [];

  // DOMÂèÇÁÖß
  const fvalueScreen = document.getElementById("fvalue-screen");
  const bpmScreen = document.getElementById("bpm-screen");
  const cameraScreen = document.getElementById("camera-screen");
  const fvalueCircle = document.getElementById("fvalue-circle");
  const fvalueText = document.getElementById("fvalue-text");
  const nextBtn = document.getElementById("next-btn");
  const bpmStatus = document.getElementById("bpm-status");
  const bpmStartBtn = document.getElementById("bpm-start-btn");
  const bpmGraph = document.getElementById("bpm-graph");
  const bpmInfo = document.getElementById("bpm-info");
  const bpmNextBtn = document.getElementById("bpm-next-btn");
  const video = document.getElementById("video");
  const photoCanvas = document.getElementById("photo-canvas");
  const captureBtn = document.getElementById("capture-btn");
  const album = document.getElementById("album");

  const photoCtx = photoCanvas.getContext("2d");
  const bpmCtx = bpmGraph.getContext("2d");

  // „Ç´„É°„É©„Çπ„Éà„É™„Éº„É†ÂèñÂæó
  let videoStream;
  let videoTrack;

  try {
    videoStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
    video.srcObject = videoStream;
    videoTrack = videoStream.getVideoTracks()[0];
  } catch(e) {
    alert("„Ç´„É°„É©Ëµ∑Âãï„Å´Â§±Êïó„Åó„Åæ„Åó„ÅüÔºö" + e);
    return;
  }

  // --- FÂÄ§Ë®≠ÂÆöÁîªÈù¢Âá¶ÁêÜ ---
  let lastPinchDist = 0;
  function updateFValueText(){
    fvalueText.textContent = fValue.toFixed(1);
    fvalueCircle.setAttribute("aria-valuenow", fValue.toFixed(1));
    // ÂÜÜ„ÅÆÂ§ß„Åç„Åï„ÇíÂ§âÂåñÔºà„É¨„É≥„Ç∫Áµû„Çä„Ç§„É°„Éº„Ç∏Ôºâ
    // 2‚ÜíÂ§ß„Åç„Åè 18‚ÜíÂ∞è„Åï„Åè (ÈÄÜ„Å´Ë¶ã„ÇÑ„Åô„ÅÑ„Çà„ÅÜ„Å´Ë™øÊï¥)
    let size = 180 - (fValue - FVAL_MIN) / (FVAL_MAX - FVAL_MIN) * 100;
    size = Math.min(220, Math.max(120, size));
    fvalueCircle.style.width = size + "px";
    fvalueCircle.style.height = size + "px";
  }
  updateFValueText();

  fvalueCircle.addEventListener("touchstart", (e) => {
    if(e.touches.length === 2){
      lastPinchDist = Math.hypot(
        e.touches[0].clientX - e.touches[1].clientX,
        e.touches[0].clientY - e.touches[1].clientY
      );
    }
  });
  fvalueCircle.addEventListener("touchmove", (e) => {
    if(e.touches.length === 2){
      const dist = Math.hypot(
        e.touches[0].clientX - e.touches[1].clientX,
        e.touches[0].clientY - e.touches[1].clientY
      );
      let delta = dist - lastPinchDist;
      lastPinchDist = dist;
      // delta„ÅåÊ≠£„Å™„Çâ„Éî„É≥„ÉÅ„Ç¢„Ç¶„Éà(Êã°Â§ß) ‚Üí FÂÄ§Â∞è„Åï„ÅèÔºà„É¢„É§Â¢ó„Åà„ÇãÔºâ
      // delta„ÅåË≤†„Å™„Çâ„Éî„É≥„ÉÅ„Ç§„É≥(Á∏ÆÂ∞è) ‚Üí FÂÄ§Â§ß„Åç„ÅèÔºà„É¢„É§Ê∏õ„ÇãÔºâ
      fValue -= delta * 0.02;
      fValue = Math.min(FVAL_MAX, Math.max(FVAL_MIN, fValue));
      updateFValueText();
      e.preventDefault();
    }
  });
  // „Ç≠„Éº„Éú„Éº„ÉâÊìç‰Ωú„ÇÇÂ∞ë„ÅóÂØæÂøúÔºà‰∏ä‰∏ã„Ç≠„ÉºÔºâ
  fvalueCircle.addEventListener("keydown", (e) => {
    if(e.key === "ArrowUp"){
      fValue = Math.max(FVAL_MIN, fValue - 0.2);
      updateFValueText();
      e.preventDefault();
    }
    if(e.key === "ArrowDown"){
      fValue = Math.min(FVAL_MAX, fValue + 0.2);
      updateFValueText();
      e.preventDefault();
    }
  });

  nextBtn.onclick = () => {
    // FÂÄ§Ê±∫ÂÆö„Åó„Å¶BPMÊ∏¨ÂÆöÁîªÈù¢„Å∏
    fvalueScreen.style.display = "none";
    bpmScreen.style.display = "flex";
  };

  // --- BPMÊ∏¨ÂÆöÁîªÈù¢Âá¶ÁêÜ ---
  let bpmMeasuring = false;
  let bpmMeasureStart = 0;
  const BPM_MEASURE_DURATION = 8000;
  bpmGraph.width = 300;
  bpmGraph.height = 120;

  function drawBPMGraph(){
    const arr = bpmHistory.slice(-200).map(o => o.v);
    if(arr.length === 0) return;
    const min = Math.min(...arr);
    const max = Math.max(...arr);
    bpmCtx.clearRect(0,0,bpmGraph.width,bpmGraph.height);
    bpmCtx.beginPath();
    arr.forEach((v,i) => {
      let x = (i/arr.length)*bpmGraph.width;
      let y = bpmGraph.height - ((v - min) / (max - min + 1e-6))*bpmGraph.height;
      i === 0 ? bpmCtx.moveTo(x,y) : bpmCtx.lineTo(x,y);
    });
    bpmCtx.strokeStyle = "#0f8";
    bpmCtx.lineWidth = 2;
    bpmCtx.stroke();
  }

  function calcBPMFromHistory(){
    if(bpmHistory.length < 60) return 0;
    const vals = bpmHistory.map(o=>o.v);
    const times = bpmHistory.map(o=>o.t);
    const dur = (times[times.length-1] - times[0])/1000;
    if(dur < 5) return 0;
    const mean = vals.reduce((a,b)=>a+b)/vals.length;
    const cen = vals.map(v => v-mean);
    const std = Math.sqrt(cen.map(v=>v*v).reduce((a,b)=>a+b)/cen.length);
    if(std < 0.5) return 0;

    const n = cen.length;
    const re = new Array(n).fill(0), im = new Array(n).fill(0);
    for(let k=0;k<n;k++){
      for(let t=0;t<n;t++){
        const ang = (2*Math.PI*t*k)/n;
        re[k] += cen[t]*Math.cos(ang);
        im[k] -= cen[t]*Math.sin(ang);
      }
    }
    const power = re.map((r,i) => Math.hypot(r,im[i]));
    const freqRes = 1/dur;
    const peaks = power.map((p,i) => ({bpm:i*freqRes*60,power:p})).filter(o => o.bpm >= 40 && o.bpm <= 200);
    if(peaks.length === 0) return 0;
    const peak = peaks.reduce((a,b) => a.power > b.power ? a : b);
    return Math.round(peak.bpm);
  }

  async function toggleTorch(on){
    if(!videoTrack) return;
    try {
      await videoTrack.applyConstraints({advanced:[{torch:on}]});
    } catch(e) {
      // torch„Åå„Å™„ÅÑÁ´ØÊú´„ÇÇ„ÅÇ„Çã
    }
  }

  bpmStartBtn.onclick = async () => {
    if(bpmMeasuring) return;
    bpmMeasuring = true;
    bpmHistory = [];
    bpmStatus.textContent = "BPM: Ë®àÊ∏¨‰∏≠...";
    bpmNextBtn.style.display = "none";
    bpmInfo.textContent = "„É©„Ç§„Éà„Å´Êåá„Çí„Åã„Åñ„Åó„Å¶Ë®àÊ∏¨„Åó„Å¶„Åè„Å†„Åï„ÅÑ";
    await toggleTorch(true);
    bpmMeasureStart = Date.now();

    // Ë®àÊ∏¨„É´„Éº„Éó
    function measureLoop(){
      if(!bpmMeasuring) return;
      const s = 100;
      const canvasTmp = document.createElement("canvas");
      canvasTmp.width = s;
      canvasTmp.height = s;
      const ctxTmp = canvasTmp.getContext("2d");
      ctxTmp.drawImage(video, (video.videoWidth-s)/2, (video.videoHeight-s)/2, s, s, 0, 0, s, s);
      const imgdata = ctxTmp.getImageData(0,0,s,s).data;
      let sum = 0;
      for(let i=0; i<imgdata.length; i+=4) sum += imgdata[i];
      bpmHistory.push({v:sum/(imgdata.length/4), t:Date.now()});
      drawBPMGraph();

      if(Date.now() - bpmMeasureStart > BPM_MEASURE_DURATION){
        bpmMeasuring = false;
        toggleTorch(false);
        bpm = calcBPMFromHistory();
        if(bpm < 40 || bpm > 200) {
