<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>F-Shutter Heart Camera</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
<style>
  body {
    margin: 0;
    overflow: hidden;
    background: #000;
    color: #fff;
    font-family: monospace;
  }
  video,
  canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  #graph {
    position: absolute;
    top: 0;
    right: 0;
    width: 200px;
    height: 100px;
    background: rgba(0, 0, 0, 0.5);
    z-index: 10;
  }
  #ui {
    position: absolute;
    top: 15px;
    left: 15px;
    background: rgba(0, 0, 0, 0.5);
    padding: 10px 15px;
    border-radius: 8px;
    z-index: 10;
    user-select: none;
    font-size: 18px;
    line-height: 1.4;
    min-width: 110px;
  }
  #instructions {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.7);
    padding: 15px;
    border-radius: 10px;
    text-align: center;
    z-index: 10;
  }
  .button-container {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 15px;
    z-index: 10;
  }
  button {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: 4px solid white;
    background: rgba(255, 255, 255, 0.3);
    font-size: 28px;
    cursor: pointer;
    user-select: none;
  }
  #flash-btn {
    background: #ff4757;
  }
  #gallery {
    position: absolute;
    bottom: 100px;
    left: 0;
    width: 100%;
    height: 90px;
    background: rgba(0, 0, 0, 0.4);
    display: flex;
    align-items: center;
    overflow-x: auto;
    gap: 8px;
    box-sizing: border-box;
    z-index: 10;
  }
  #gallery img {
    height: 100%;
    border: 2px solid white;
    border-radius: 5px;
    cursor: pointer;
    transition: transform 0.1s;
  }
  #gallery img:hover {
    transform: scale(1.05);
  }

  /* ËøΩÂä†ÔºöFÂÄ§„Éê„É≠„É°„Éº„Çø„ÉºUI */
  #fval-ui {
    position: absolute;
    top: 10px;
    left: 10px;
    width: 150px;
    height: 40px;
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid white;
    border-radius: 20px;
    cursor: pointer;
    user-select: none;
    display: flex;
    align-items: center;
    justify-content: flex-start;
    padding: 5px 10px;
    transition: width 0.3s, height 0.3s;
    z-index: 20;
  }
  #fval-indicator {
    height: 30px;
    background: #0f8;
    border-radius: 15px;
    transition: width 0.3s, height 0.3s;
  }
  #fval-text {
    margin-left: 10px;
    color: white;
    font-weight: bold;
    min-width: 60px;
    text-align: center;
    font-family: monospace;
    user-select: none;
  }
</style>
</head>
<body>
  <video id="video" playsinline autoplay muted></video>
  <canvas id="canvas"></canvas>
  <canvas id="graph"></canvas>

  <div id="ui">
    <div id="bpm">BPM: ---</div>
    <div id="fval">FÂÄ§: 4.0</div>
  </div>

  <div id="instructions">
    <p>ËÉåÈù¢„Ç´„É°„É©„Å®„É©„Ç§„Éà„ÇíÊåá„ÅßË¶Ü„Å£„Å¶„Åè„Å†„Åï„ÅÑ</p>
    <p>‚Üì</p>
    <p>üí° „ÇíÊäº„Åó„Å¶Ë®àÊ∏¨ÈñãÂßã</p>
  </div>

  <div class="button-container">
    <button id="flash-btn">üí°</button>
    <button id="capture-btn">üì∏</button>
  </div>

  <div id="gallery"></div>

  <!-- ËøΩÂä†ÔºöFÂÄ§Ë™øÊï¥„Éê„É≠„É°„Éº„Çø„Éº -->
  <div id="fval-ui">
    <div id="fval-indicator"></div>
    <div id="fval-text">FÂÄ§: 4.0</div>
  </div>

<script>
(async () => {
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const graph = document.getElementById("graph");
  const bpmText = document.getElementById("bpm");
  const fvalText = document.getElementById("fval");
  const instr = document.getElementById("instructions");
  const flashBtn = document.getElementById("flash-btn");
  const capBtn = document.getElementById("capture-btn");
  const gallery = document.getElementById("gallery");

  const ctx = canvas.getContext("2d");
  const gctx = graph.getContext("2d");

  // FÂÄ§UIË¶ÅÁ¥†
  const fvalUI = document.getElementById("fval-ui");
  const fvalIndicator = document.getElementById("fval-indicator");
  const fvalText2 = document.getElementById("fval-text");

  let videoTrack;
  let scale = 1;
  let fValue = 4;
  let bpm = 0;
  let avgBpm = 80; // Ê®ôÊ∫ñÂÄ§„Çí80„Å´Ë®≠ÂÆö

  let measuring = false;
  let history = [];
  let lastPinch = 0;

  // „Éâ„É©„ÉÉ„Ç∞„Éï„É©„Ç∞
  let dragging = false;

  // „Ç´„É°„É©Ëµ∑Âãï
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" }
    });
    video.srcObject = stream;
    videoTrack = stream.getVideoTracks()[0];
  } catch (err) {
    alert("„Ç´„É°„É©Ëµ∑ÂãïÂ§±ÊïóÔºö" + err);
    return;
  }

  function resize() {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    graph.width = 200;
    graph.height = 100;
  }
  video.addEventListener("loadeddata", () => {
    resize();
    requestAnimationFrame(loop);
  });
  window.addEventListener("resize", resize);

  // FÂÄ§UIÊõ¥Êñ∞Èñ¢Êï∞
  function updateFvalUI(fval) {
    const minF = 1.0;
    const maxF = 16.0;
    const clamped = Math.min(maxF, Math.max(minF, fval));
    fValue = clamped;

    // „Éé„Éº„Éû„É©„Ç§„Ç∫ÔºàFÂÄ§Â∞è„Åï„ÅÑ„Åª„Å©Â§ß„Åç„ÅèË°®Á§∫Ôºâ
    const norm = (maxF - clamped) / (maxF - minF); // 0„Äú1
    const width = 50 + norm * 100;  // 50„Äú150px
    const height = 20 + norm * 20;  // 20„Äú40px

    fvalUI.style.width = `${width}px`;
    fvalUI.style.height = `${height}px`;
    fvalIndicator.style.width = `${width * norm}px`;
    fvalIndicator.style.height = `${height - 10}px`;
    fvalText2.innerText = `FÂÄ§: ${clamped.toFixed(1)}`;

    // UIÂÜÖ„Å®Êó¢Â≠òUI„ÅÆFÂÄ§Ë°®Á§∫ÂêåÊúü
    fvalText.innerText = `FÂÄ§: ${clamped.toFixed(1)}`;
  }

  // ÂàùÊúüË°®Á§∫
  updateFvalUI(fValue);

  // „Éâ„É©„ÉÉ„Ç∞ÈñãÂßã
  fvalUI.addEventListener("mousedown", (e) => {
    dragging = true;
    e.preventDefault();
  });
  window.addEventListener("mouseup", () => {
    dragging = false;
  });
  window.addEventListener("mousemove", (e) => {
    if (!dragging) return;
    const rect = fvalUI.getBoundingClientRect();
    let pos = e.clientX - rect.left;
    pos = Math.min(rect.width, Math.max(0, pos));
    const newFval = 1 + (pos / rect.width) * 15;
    updateFvalUI(newFval);
  });

  // „Çø„ÉÉ„ÉÅÂØæÂøú
  fvalUI.addEventListener("touchstart", (e) => {
    dragging = true;
    e.preventDefault();
  });
  window.addEventListener("touchend", () => {
    dragging = false;
  });
  window.addEventListener("touchmove", (e) => {
    if (!dragging) return;
    const touch = e.touches[0];
    const rect = fvalUI.getBoundingClientRect();
    let pos = touch.clientX - rect.left;
    pos = Math.min(rect.width, Math.max(0, pos));
    const newFval = 1 + (pos / rect.width) * 15;
    updateFvalUI(newFval);
  });

  // „É°„Ç§„É≥„É´„Éº„Éó
  function loop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.filter = "none";
    ctx.globalAlpha = 1;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    if (measuring) {
      const s = 100;
      const x = canvas.width / 2 - s / 2,
        y = canvas.height / 2 - s / 2;
      const dat = ctx.getImageData(x, y, s, s).data;
      let sum = 0;
      for (let i = 0; i < dat.length; i += 4) sum += dat[i];
      history.push({ v: sum / (dat.length / 4), t: Date.now() });
      drawGraph();
    }

    // Êòé„Çã„ÅïË™øÊï¥: BPM„Åå80„ÇíÂü∫Ê∫ñ„ÄÅ60‰ª•‰∏ã„ÅßÊòé„Çã„Åè„ÄÅ100‰ª•‰∏ä„ÅßÊöó„Åè
    let alphaBase = 1;
    if (bpm <= 60) {
      alphaBase = 1.3;
    } else if (bpm >= 100) {
      alphaBase = 0.7;
    }

    // fValue„Å´ÈÄ£Âãï„Åó„Åü„Ç∞„É≠„Éº„Éê„É´„Ç¢„É´„Éï„Ç°Ë®≠ÂÆö
    ctx.globalAlpha = (4 / fValue) * alphaBase;

    requestAnimationFrame(loop);
  }

  // „Ç∞„É©„ÉïÊèèÁîª
  function drawGraph() {
    const arr = history.slice(-200).map((o) => o.v);
    const min = Math.min(...arr),
      max = Math.max(...arr);
    gctx.clearRect(0, 0, 200, 100);
    gctx.beginPath();
    arr.forEach((v, i) => {
      const x = (i / arr.length) * 200;
      const y = 100 - ((v - min) / (max - min + 1e-6)) * 100;
      i === 0 ? gctx.moveTo(x, y) : gctx.lineTo(x, y);
    });
    gctx.strokeStyle = "#0f8";
    gctx.lineWidth = 1.5;
    gctx.stroke();
  }

  // BPMË®àÁÆóÔºàFFT„ÅÆÁ∞°ÊòìÁâàÔºâ
  function calcBPM() {
    const h = history;
    if (h.length < 60) return 0;
    const vals = h.map((o) => o.v),
      times = h.map((o) => o.t);
    const dur = (times[times.length - 1] - times[0]) / 1000;
    if (dur < 5) return 0;
    const mean = vals.reduce((a, b) => a + b) / vals.length;
    const cen = vals.map((v) => v - mean);
    const std = Math.sqrt(
      cen.map((v) => v * v).reduce((a, b) => a + b) / cen.length
    );
    if (std < 0.5) return 0;

    const n = cen.length;
    const re = new Array(n).fill(0),
      im = new Array(n).fill(0);
    for (let k = 0; k < n; k++)
      for (let t = 0; t < n; t++) {
        const ang = (2 * Math.PI * t * k) / n;
        re[k] += cen[t] * Math.cos(ang);
        im[k] -= cen[t] * Math.sin(ang);
      }

    let maxMag = 0,
      peakIndex = 0;
    for (let k = 1; k < n / 2; k++) {
      const mag = Math.sqrt(re[k] * re[k] + im[k] * im[k]);
      if (mag > maxMag) {
        maxMag = mag;
        peakIndex = k;
      }
    }
    const bpmCalc = 60 / (dur / peakIndex);
    return bpmCalc;
  }

  // Ë®àÊ∏¨ÈñãÂßã„Éú„Çø„É≥
  flashBtn.addEventListener("click", () => {
    if (measuring) {
      measuring = false;
      instr.style.display = "block";
      bpmText.innerText = "BPM: ---";
      bpm = 0;
      history = [];
    } else {
      measuring = true;
      instr.style.display = "none";
      history = [];
    }
  });

  // „Ç≠„É£„Éó„ÉÅ„É£„Éú„Çø„É≥ÔºàÁîªÂÉè‰øùÂ≠òÔºâ
  capBtn.addEventListener("click", () => {
    const url = canvas.toDataURL("image/jpeg", 0.8);
    const img = document.createElement("img");
    img.src = url;
    gallery.appendChild(img);
  });

  // „Éõ„Ç§„Éº„É´Êìç‰Ωú„ÅßFÂÄ§Â§âÊõ¥„ÉªUIÂêåÊúü
  window.addEventListener("wheel", (e) => {
    if (e.deltaY < 0) {
      updateFvalUI(fValue - 0.5);
    } else if (e.deltaY > 0) {
      updateFvalUI(fValue + 0.5);
    }
  });

  // BPMË°®Á§∫Êõ¥Êñ∞„É´„Éº„Éó
  setInterval(() => {
    if (measuring) {
      const bpmCalc = calcBPM();
      if (bpmCalc > 30 && bpmCalc < 180) {
        bpm = bpmCalc;
        avgBpm = bpmCalc;
      } else {
        bpm = avgBpm;
      }
      bpmText.innerText = `BPM: ${bpm.toFixed(1)}`;
    }
  }, 1000);
})();
</script>
</body>
</html>
